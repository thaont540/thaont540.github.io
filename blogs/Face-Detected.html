<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:b="http://www.google.com/2005/gml/b" xmlns:data="http://www.google.com/2005/gml/data" xmlns:expr="http://www.google.com/2005/gml/expr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="css/4205868711-css_bundle_v2.css" type="text/css" media="screen">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" media="screen">
    <link rel="stylesheet" href="css/font.css" type="text/css" media="screen">
    <link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta content="blogger" name="generator">
    <link rel="icon" type="image/x-icon" href="https://media.giphy.com/media/mRrXIdhpDXv1e/giphy.gif">
    <title>[ThaoNT] Face detected</title>
    <style id="page-skin-1" type="text/css">
    </style>
</head>
<body class="">
<div class="navbar no-items section" id="navbar" name="Navbar"></div>
<div id="outer-wrapper">
    <div id="left-wrapper">
        <div id="toggle-wrapper">
            <a href="#"><span class="fa fa-bars"></span></a>
        </div>
        <div class="left section" id="header" name="Header">
            <div class="widget Header" data-version="1" id="Header1">
                <div id="header-inner">
                    <div class="titlewrapper">
                        <h1 class="title">
                            <a href="#">Nguyễn Thế Thạo</a>
                        </h1>
                    </div>
                    <div class="descriptionwrapper">
                        <p class="description"><span>Mỗi khi cảm thấy cuộc đời bế tắc, bạn nên đi ngủ, để thấy rằng, ngủ cũng *éo được T.T</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="left section" id="menu" name="Menu" style="display: none;">
            <div class="widget PageList" data-version="1" id="PageList1">
                <h2>Menu</h2>
                <div class="widget-content">
                    <ul>
                        <li><a href="/">Trang chủ</a></li>
                        <li><a href="https://www.facebook.com/buonmotchutthoi/photos_albums?lst=100000222967559%3A100000222967559%3A1482594147">Ấn vào đây</a></li>
                        <li><a href="#">Đừng ấn vào đây</a></li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="main-wrapper">
        <div id="post-toolbar">
            <a href="##" id="full-screen" title="Toggle Fullscreen"><span class="fa fa-expand"></span></a>
            <div class="font-size">
                <a href="##" id="smaller-font" title="Smaller Font Size"><span class="fa fa-minus"></span></a>
                <a href="##" id="default-font" title="Default Font Size"><span class="fa fa-font"></span></a>
                <a href="##" id="larger-font" title="Larger Font Size"><span class="fa fa-plus"></span></a>
            </div>
        </div>
        <div class="main right section" id="main" name="Main">
            <div class="widget Blog" data-version="1" id="Blog1">
                <div class="blog-posts hfeed">
                    <div class="date-outer">
                        <div class="date-posts">
                            <div class="post-outer">
                                <div class="post hentry" itemprop="blogPost thing" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
                                    <h2 class="date-header">
                                        <span class="fa fa-calendar-o"></span>
                                        <span>
                                                    Thứ 5, ngày 19/8/2021
                                                </span>
                                    </h2>
                                    <h3 class="post-title entry-title" content="[ThaoNT] PHP Reflection" itemprop="headline">
                                        [ThaoNT] Nhận dạng khuôn mặt bằng javascript
                                    </h3>
                                    <div class="post-header">
                                        <div class="post-header-line-1">
                                                    <span class="post-author vcard">
                                                        Được viết bởi
                                                        <span class="fn" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
                                                            <a class="g-profile" href="#" rel="author" title="author profile" data-gapiscan="true" data-onload="true" data-gapiattached="true">
                                                            <span itemprop="name">Thạo hihi</span>
                                                            </a>
                                                        </span>
                                                    </span>
                                            <span class="post-timestamp">
                                                        vào lúc
                                                        <a class="timestamp-link" href="#" rel="bookmark" title="permanent link"><abbr class="published" itemprop="datePublished" title="A hihi">19/8/2021</abbr></a>
                                                    </span>
                                            <span class="post-labels">
                                                    nằm trong chuyên mục
                                                    <a href="#" rel="tag">Code vì food</a>
                                                    </span>
                                        </div>
                                    </div>
                                    <div class="post-body entry-content" id="post-body" itemprop="description articleBody">
                                    </div>
                                    <div id="test"></div>
                                    <div class="post-footer">
                                        <div class="author-profile" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
                                            <img alt="Author" itemprop="image" src="https://scontent.fhan2-2.fna.fbcdn.net/v/t1.0-9/10406576_978682265482530_6327681735274055371_n.jpg?oh=a7ba523b19e7c92294c66ab01a4a7297&oe=58E0E5EF" width="50px">
                                            <div>
                                                <a class="g-profile" href="/" itemprop="url" rel="author" title="author profile" data-gapiscan="true" data-onload="true" data-gapiattached="true">
                                                    <span itemprop="name">Thạo</span>
                                                </a>
                                            </div>
                                            <span itemprop="description">Heyo! I'm Thạo, Nice to meat you :#)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
        </div>
        <div class="clear"></div>
    </div>
</div>
<script src="js/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript">
    //<![CDATA[
    $(window).load(function(){
        $("#preloader").fadeOut('slow');
    });
    //]]>
</script>
<script type="text/javascript">
    //<![CDATA[
    $(document).ready(function(){
        $('#menu').hide();
        $('#toggle-wrapper a').click(function(e){
            e.preventDefault();
            var icon = $(this).find('span');
            if(icon.hasClass('fa-bars')){
                icon.removeClass('fa-bars').addClass('fa-close');
                $('#menu').fadeIn();
            }else{
                icon.removeClass('fa-close').addClass('fa-bars');
                $('#menu').fadeOut();
            }
        });
    });
    //]]>
</script>
<script type="text/javascript">
    //<![CDATA[
    $(function(){
        if($('.post-body iframe').length>0){
            $('.post-body iframe').each(function(){
                var youtube = new RegExp('youtube'), vimeo = new RegExp('vimeo'), dailymotion = new RegExp('dailymotion'), metacafe = new RegExp('metacafe');
                if(youtube.test($(this).attr('src')) || vimeo.test($(this).attr('src')) || dailymotion.test($(this).attr('src')) || metacafe.test($(this).attr('src'))){
                    $(this).wrap('<div class="video-container">');
                }
                youtube = null;
                vimeo = null;
                dailymotion = null;
                metacafe = null;
            });
        }
        var normalFontSize = $('.post-body').css('font-size');
        if($('blockquote').length){
            var quoteNormalFontSize = $('blockquote').css('font-size').replace('px','');
        }
        $('#smaller-font').click(function(e){
            e.preventDefault();
            var currentSize = $('.post-body').css('font-size').replace('px','');
            if(currentSize > 10){
                $('.post-body').css('font-size',(currentSize-2)+'px');
                if($('blockquote').length){
                    $('blockquote').css('font-size',(quoteNormalFontSize-2)+'px');
                }
            }
        });
        $('#larger-font').click(function(e){
            e.preventDefault();
            var currentSize = $('.post-body').css('font-size').replace('px','');
            if(currentSize < 30){
                $('.post-body').css('font-size',(+currentSize+2)+'px');
                if($('blockquote').length){
                    $('blockquote').css('font-size',(+quoteNormalFontSize+2)+'px');
                }
            }
        });
        $('#default-font').click(function(e){
            e.preventDefault();
            $('.post-body').css('font-size',normalFontSize);
            if($('blockquote').length){
                $('blockquote').css('font-size',quoteNormalFontSize);
            }
        });
        $('#full-screen').click(function(e){
            e.preventDefault();
            var leftWrap = $('#left-wrapper'), outerWrap = $('#outer-wrapper'), mainWrap = $('#main-wrapper'), footerWrap = $('#footer-wrapper'), toggle = $(this), leftWrapWidth = leftWrap.width();
            if(leftWrap.css('left') != -leftWrapWidth+'px'){
                leftWrap.animate({'left':-leftWrapWidth},400);
                outerWrap.animate({'padding-left':0},400);
                mainWrap.animate({'width':$(window).width()},400);
                footerWrap.animate({'margin-left':0},400);
                toggle.find('span').addClass('fa-compress').removeClass('fa-expand');
            }else{
                leftWrap.animate({'left':leftWrapWidth},400);
                outerWrap.animate({'padding-left':leftWrapWidth+'px'},400);
                mainWrap.animate({'width':$(window).width()-leftWrapWidth},400);
                footerWrap.animate({'margin-left':leftWrapWidth+'px'},400);
                toggle.find('span').addClass('fa-expand').removeClass('fa-compress');
            }
        });
    });
    //]]>

</script>
<div id="footer-wrapper">
    <div class="foot no-items section" id="footer-1" name="Footer 1"></div>
    <table border="0" cellpadding="0" cellspacing="0" class="section-columns columns-2">
        <tbody>
        <tr>
            <td class="first columns-cell">
                <div class="foot section" id="footer-2-1" name="Footer 2 - 1">
                    <div class="widget BlogArchive" data-version="1" id="BlogArchive1">
                        <h2>Lưu trữ</h2>
                        <div class="widget-content">
                            <div id="ArchiveList">
                                <div id="BlogArchive1_ArchiveList">
                                    <ul class="flat">
                                        <li class="archivedate">
                                            <a href="#/2016_01_01_archive.html">January</a> (1)
                                        </li>
                                        <li class="archivedate">
                                            <a href="#/2015_12_01_archive.html">December</a> (6)
                                        </li>
                                        <li class="archivedate">
                                            <a href="#/2015_11_01_archive.html">November</a> (3)
                                        </li>
                                        <li class="archivedate">
                                            <a href="#/2015_10_01_archive.html">October</a> (1)
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div class="widget Label" data-version="1" id="Label1">
                        <h2>Vài thứ hay hay</h2>
                        <div class="widget-content list-label-widget-content">
                            <ul>
                                <li>
                                    <a dir="ltr" href="https://www.facebook.com/buonmotchutthoi/photos_albums?lst=100000222967559%3A100000222967559%3A1482595209">Awesome Pics</a>
                                    <span dir="ltr">(1)</span>
                                </li>
                                <li>
                                    <a dir="ltr" href="https://viblo.asia/users/show/thaont">Coding</a>
                                    <span dir="ltr">(2)</span>
                                </li>
                                <li>
                                    <a dir="ltr" href="http://mp3.zing.vn/playlist/SadEyes-haianh_friend/IW8C7OWU.html">Music</a>
                                    <span dir="ltr">(2)</span>
                                </li>
                                <li>
                                    <a dir="ltr" href="http://tonvinhvanhoadoc.vn/van-hoc-viet-nam/sang-tac/12107-truyen-ngan-thach-lam-ben-kia-song.html">Truyện ngắn Thạch Lam</a>
                                    <span dir="ltr">(3)</span>
                                </li>
                            </ul>
                            <div class="clear"></div>
                        </div>
                    </div>
                </div>
            </td>
            <td class="columns-cell">
                <div class="foot section" id="footer-2-2" name="Footer 2 - 2">
                    <div class="widget PopularPosts" data-version="1" id="PopularPosts1">
                        <h2>Chắc là nhiều người muốn xem?</h2>
                        <div class="widget-content popular-posts">
                            <ul>
                                <li>
                                    <div class="item-content">
                                        <div class="item-thumbnail">
                                            <a href="#" target="_blank">
                                                <img alt="" border="0" src="images/code-820275_1920(1).jpg">
                                            </a>
                                        </div>
                                        <div class="item-title"><a href="https://viblo.asia/thaont/posts/OREGwBxzvlN" target="_blank">Extension Make silence cho Chatwork</a></div>
                                        <div class="item-snippet">Chắc hẳn là chúng ta ít nhất tham gia 1 hoặc nhiều mạng xã hội hoặc diễn đàn nào đó. Và tất nhiên, tỷ lệ gặp những kẻ khó ưa càng cao đối với lượng thành viên càng lớn...</div>
                                    </div>
                                    <div style="clear: both;"></div>
                                </li>
                                <li>
                                    <div class="item-content">
                                        <div class="item-title"><a href="https://viblo.asia/thaont/posts/ZabG9zYzvzY6" target="_blank">Làm quen với Shell Script</a></div>
                                        <div class="item-snippet">Shell là một chương trình thông dịch lệnh của một hệ điều hành, cung cấp cho người dùng khả năng tương tác với hệ điều hành bằng cách gõ từng lệnh ở chế độ dòng lệnh, đồng thời trả lại kết quả thực hiện lệnh lại cho người sử dụng. Shell cung cấp tập hợp các lệnh đặc biệt mà từ đó có ...</div>
                                    </div>
                                    <div style="clear: both;"></div>
                                </li>
                                <li>
                                    <div class="item-content">
                                        <iframe width="280" height="140" src="https://www.youtube.com/embed/sbfks7HdRoE" frameborder="0" allowfullscreen></iframe>
                                    </div>
                                    <div style="clear: both;"></div>
                                </li>
                            </ul>
                            <div class="clear"></div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <!-- outside of the include in order to lock Attribution widget -->
    <div class="foot section" id="footer-3" name="Footer">
        <div class="widget Attribution" data-version="1" id="Attribution1">
            <div class="widget-content" style="text-align: center;">
                © Hí hí @. Powered by <a href="#" target="_blank">Thạo đại ca</a>.
            </div>
            <div class="clear"></div>
        </div>
    </div>
</div>
<script type="text/javascript" src="js/803954089-widgets.js"></script>
<script type="text/javascript" src="js/plusone.js" gapi_processed="true"></script>
<link type="text/css" rel="stylesheet" href="css/368954415-lightbox_bundle.css">
<script type="text/javascript" src="js/2371771562-lbx__en_gb.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/4.4.0/markdown-it.min.js"></script>
<script type="text/javascript">
    $(function () {
        var xmp = $('xmp#markdown');
        var mdText = xmp.html();
        var md = window.markdownit();
        $('#post-body').html(md.render(mdText));
    });
</script>
</body>
<xmp id="markdown" style="display: none;">

## Giới thiệu
Đôi khi muốn làm 1 cái gì đó mà mình lại không làm được, thế là mình lại tìm cách khác để làm được việc đó. Ví dụ như mình muốn tự làm 1 cái app nhận diện khuôn mặt từ camera để làm nhiều thứ hay ho hơn theo cách của mình, thay vì dùng những app có sẵn. Thế là nghĩ ngay rồi tìm hiểu xem bằng kiến thức của mình, có làm được điều đó không.
### Việc cần làm

- Tất cả các chức năng đều được thực hiện bằng js và html
- Lấy nguồn video từ camera
- Phát hiện khuôn mặt có trong video
- Xác định khuôn mặt đó thuộc về ai
- Thêm ô ghi thông tin lên khuôn mặt bằng canvas

### Vấn đề

- Để nhận diện được "khuôn mặt" thì chắc là chúng ta cần phải viết 1 đoạn code python, rồi chạy training nhận diện khuôn mặt với 1 bộ dữ liệu kha khá để ra được một cái model có thể dùng.
- Tất nhiên là chúng ta không có thời gian để làm như thế được rồi, thế nên là giờ chúng ta sẽ dùng 1 thư viện tên là [face api](https://github.com/justadudewhohacks/face-api.js/) và sử dụng các bộ model đã được training sẵn [tại đây](https://github.com/justadudewhohacks/face-api.js/tree/master/weights) để  thực hiện công việc "phát hiện khuôn mặt"

## Vào việc
### Chuẩn bị
- Thêm vào html hiển thị video
```html
<canvas id="canvas" class="overlay"></canvas>
<video autoplay="true" id="videoElement"></video>
```
- Thêm thư viện face-api: ta có thể xem cách cài đặt tại [đây](https://github.com/justadudewhohacks/face-api.js/) hoặc đơn giản là download file js về và dùng
```html
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/face-api.js"></script>
<script src="js/app.js"></script>
```

File `app.js` là file js mà chúng ta sẽ sử dụng để viết logic của mình.

### Kiểm tra xem trình duyệt có cho dùng camera hay không
```js
let video = document.querySelector('#videoElement');

if (navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
        video.srcObject = stream;
    })
    .catch(function (err) {
        console.log('Không có camera bạn ơi!');
    });
}
```

### Khi mà camera chạy ổn rồi, thì gọi function của chúng ta thôi

```js
$('#videoElement').bind('loadedmetadata', function() {
    let displaySize = { width:this.scrollWidth, height: this.scrollHeight };
    detect(video, displaySize).then(a => {
        console.log('Đang chạy rồi đây bạn ơi');
    });
});
```

- Ở đây, `displaySize` dùng để căn chỉnh cho ô thông tin bằng canvas trùng vào khuôn mặt được phát hiện
- Logic nhận diện khuôn mặt chúng ta sẽ viết trong function `detect`

### Load model nhận diện khuôn mặt
```js
async function detect(video, displaySize) {
    await faceapi.loadSsdMobilenetv1Model('/models');
    await faceapi.loadFaceLandmarkModel('/models');
    await faceapi.loadFaceRecognitionModel('/models');
}
```

Về nguyên lý hoạt động, mọi người có thể tự tìm hiểu thêm bằng cách [google](https://www.google.com/) từ khóa `recognition face theory`

Ở đây, faceapi sẽ sử dụng những mô hình này để dự đoán những tọa độ được cho là mắt, mũi, miệng,... mà nó đã được dạy từ trước, có tất cả là 68 tọa độ như thế để xác định khuôn mặt (Facial LandMark).

### Gán nhãn khuôn mặt

Công việc nhận diện khuôn mặt ở đây bao gồm 2 bước
- Gán nhã cho 1 khuôn mặt đã xác định (kiểu như ảnh của cái mặt của tôi, rồi bảo đây là mặt Thạo)\
- So sánh khuôn mặt được phát hiện trong camera với những khuôn mặt đã xác định => cái nào trùng thì có nghĩa là đã nhận diện được người đó trong camera

Do đó, việc gán nhãn khuôn mặt sẽ được thực hiện bằng cách:
```js
const labels = ['thao', 'hoa'];
const labeledFaceDescriptors = await Promise.all(
    labels.map(async label => {
    const imgUrl = `faces/${label}.JPG`
    const img = await faceapi.fetchImage(imgUrl)
    const fullFaceDescription = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor()
    if (!fullFaceDescription) {
        throw new Error(`no faces detected for ${label}`);
    }

    const faceDescriptors = [fullFaceDescription.descriptor]
        return new faceapi.LabeledFaceDescriptors(label, faceDescriptors)
    })
);
```

Chức năng của đoạn code trên là:
- Chạy 1 vòng những nhãn được định nghĩa (tên của cái mặt)
- Lấy dữ liệu ảnh tương ứng với tên nhãn
- Phát hiện mặt trong ảnh (sinh ra 68 điểm Facial LandMark như đã nói ở trên)
- Gán nhãn cho những cái mặt đó, nôm na là: mặt này là của `Thao`, mặt này là của `Hoa`

![](images/face_detect_labels.jpg)
### Phát hiện khuôn mặt từ camera

```js
let fullFaceDescriptions = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
let canvas = $('#canvas').get(0);
faceapi.matchDimensions(canvas, displaySize);
```

=> Phát hiện tất cả mặt có trong khung hình của video và gán ô ghi thông tin lên khuôn mặt bằng canvas

### Nhận diện khuôn mặt

```js
const maxDescriptorDistance = 0.4
const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDescriptorDistance)
const results = fullFaceDescriptions.map(fd => faceMatcher.findBestMatch(fd.descriptor))
results.forEach((bestMatch, i) => {
    const box = fullFaceDescriptions[i].detection.box
    const text = bestMatch.toString()
    const drawBox = new faceapi.draw.DrawBox(box, { label: text })
    drawBox.draw(canvas);
    $('.show-text').text(text);
});
```

Ở đây, chúng ta xác định khuôn mặt nào là của người nào bằng cách tính toán khoảng cách Euclidean của khuôn mặt trong camera, rồi so sánh nó với khoảng cách Euclidean của khuôn mặt đã được xác định, và `maxDescriptorDistance` là ngưỡng mà Euclidean của `khuôn mặt đã được xác định` so với Euclidean của `khuôn mặt trong camera`. Không rõ là mình có hiểu nhầm đoạn này không, nhưng đại loại cái này nó như `độ chính xác` khi so sánh 2 khuôn mặt xem nó khớp tới bao nhiêu phần trăm vậy.

Sau đó thì viết thông tin xác định được lên box canvas.

### Hoàn thành

Vì cần phải thực hiện việc detect face theo thời gian thực (video luôn chạy mà) nên cần nhét tất cả logic trên vào `setInterval()`, cụ thể thì nó sẽ như thế này:
```js
setInterval(async () => {
    const labels = ['thao', 'hoa'];

    const labeledFaceDescriptors = await Promise.all(
    labels.map(async label => {
        const imgUrl = `faces/${label}.JPG`
        const img = await faceapi.fetchImage(imgUrl)
        const fullFaceDescription = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor()
        if (!fullFaceDescription) {
            throw new Error(`no faces detected for ${label}`);
        }

        const faceDescriptors = [fullFaceDescription.descriptor]
            return new faceapi.LabeledFaceDescriptors(label, faceDescriptors)
        })
    );

    let fullFaceDescriptions = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
    let canvas = $('#canvas').get(0);
    faceapi.matchDimensions(canvas, displaySize);

    const maxDescriptorDistance = 0.4
    const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDescriptorDistance)

    const results = fullFaceDescriptions.map(fd => faceMatcher.findBestMatch(fd.descriptor))

    results.forEach((bestMatch, i) => {
        const box = fullFaceDescriptions[i].detection.box
        const text = bestMatch.toString()
        const drawBox = new faceapi.draw.DrawBox(box, { label: text })
        drawBox.draw(canvas);
        $('.show-text').text(text);
    });

}, 300);
```

Cái time interval là `300`, tức là cứ 0.3 giây thì tìm kiếm khuôn mặt trong khung hình 1 lần, sẽ thấy nó hơi lag lag, có thể giảm xuống hoặc tăng lên. Nếu giảm về 0 thì trình duyệt của bạn có lẽ sẽ mệt mỏi mà chết.

### Kết quả

![](images/detect.gif)

## Kết luận
Tham khảo

- [Face api js](https://github.com/justadudewhohacks/face-api.js)
- [Recognition face theory](https://www.google.com/search?sxsrf=ALeKk033qnA6cSqVHpzQOger4SS5eB_irQ:1629369910119&q=recognition+face+theory&sa=X&ved=2ahUKEwiPusz187zyAhVQCd4KHRGYCZAQ7xYoAHoECAEQNQ&biw=1920&bih=912)
- [Facial Recognition System with JavaScript](https://heartbeat.fritz.ai/facial-recognition-system-with-javascript-f9659c381434)
</xmp>

</html>